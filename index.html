<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Matxh Music</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='white' d='M8 12c-1.66 0-3-1.34-3-3V3c0-1.66 1.34-3 3-3s3 1.34 3 3v6c0 1.66-1.34 3-3 3zm5-5H11v.5a5 5 0 0 0 5 5h-1a4 4 0 0 1-4-4V7zM5 7H3v.5a4 4 0 0 1-4 4h-1a5 5 0 0 0 5-5V7z'/></svg>" type="image/svg+xml">

    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        @font-face {
            font-family: 'Sekuya';
            src: url('fonts/Sekuya.woff2') format('woff2'),
                 url('fonts/Sekuya.woff') format('woff');
            font-weight: 400 700;
            font-style: normal;
            font-display: swap;
        }

        :root {
            /* --- SITE WIDE THEME COLORS --- */
            --bg-gradient-start: #a211dc;
            --bg-gradient-end: #051c6f;
            
            --accent: #1db954;
            --accent-hover: #1ed760;
            
            --text-main: #ffffff;
            --text-muted: #b3b3b3;
            --control-bg: rgba(20, 20, 20, 0.65); 
            --slider-bg: #4f4f4f;
        }

        * { box-sizing: border-box; font-family: 'Josefin Sans', sans-serif; }
        
        body { 
            margin: 0; 
            height: 100vh; 
            display: grid; 
            grid-template-columns: 320px 1fr; 
            overflow: hidden; 
            color: var(--text-main); 
            background: #000000; 
        }

        /* --- HIDE SCROLLBARS (Cross-Browser) --- */
        .song-list::-webkit-scrollbar,
        .lyrics-fixed-view::-webkit-scrollbar { display: none; }
        .song-list, .lyrics-fixed-view { -ms-overflow-style: none; scrollbar-width: none; }

        /* Sidebar Styles (Unchanged) */
        .sidebar { background: #0a0a0a; border-right: 1px solid rgba(255,255,255,0.08); display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; z-index: 10; }
        .sidebar-header { padding: 24px; font-size: 24px; font-weight: 700; font-family: 'Sekuya', 'Josefin Sans', sans-serif; color: #fff; }
        .song-list { overflow-y: auto; flex: 1; }
        .song-item { padding: 12px 24px; cursor: pointer; transition: background 0.2s; border-radius: 4px; margin: 0 8px; }
        .song-item:hover { background: rgba(255,255,255,0.1); }
        .song-item.active { background: rgba(255,255,255,0.15); color: var(--accent); }
        .song-title { font-weight: 600; font-family: 'Sekuya', 'Josefin Sans', sans-serif; font-size: 16px; margin-bottom: 4px;}
        .song-artist { font-size: 13px; color: var(--text-muted); }
        .song-item.active .song-artist { color: #fff; }

        /* Main Player Area (Unchanged) */
        .player { position: relative; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%); }
        .now-playing { padding: 40px; position: absolute; top: 0; width: 100%; z-index: 5; background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%); }
        .now-title { font-size: 32px; font-weight: 700; font-family: 'Sekuya', 'Josefin Sans', sans-serif; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .now-artist { margin-top: 8px; font-size: 16px; color: rgba(255,255,255,0.8); }

        /*
        ========================================================
        CRITICAL CSS FIXES
        ========================================================
        */

        .lyrics-fixed-view { 
            flex: 1; 
            overflow: hidden; 
            position: relative; /* CRITICAL for absolute positioning of #lyrics */
            padding-top: 120px; 
            padding-bottom: 140px; 
            text-align: center; 
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%); 
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%); 
        }
        
        #lyrics { /* The container that moves */
            position: absolute;
            top: 0; /* CRITICAL FIX: Start at the top of the parent view */
            left: 50%;
            /* Horizontal centering only */
            transform: translate(-50%, 0); 
            width: 100%;
            will-change: transform;
            /* SMOOTH TRANSITION */
            transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .lyric-line { 
            font-size: 20px; 
            color: rgba(255,255,255,0.3); 
            padding: 12px 0; 
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
            cursor: pointer; 
            line-height: 1.5;
        }
        
        .lyric-line:hover { color: rgba(255,255,255,0.6); }

        /* Active Glow Effect */
        .lyric-line.active { 
            color: #ffffff; 
            font-size: 32px; 
            font-weight: 700; 
            transform: scale(1.05); 
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8),
                0 0 20px rgba(255, 255, 255, 0.5),
                0 0 30px rgba(255, 255, 255, 0.2);
        }

        /* Controls styling (Unchanged) */
        .controls { position: fixed; left: 320px; right: 0; bottom: 0; height: 100px; background: var(--control-bg); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); border-top: 1px solid rgba(255,255,255,0.08); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0 20px; z-index: 20; }
        .buttons-area { display: flex; align-items: center; gap: 24px; margin-bottom: 8px; }
        .control-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .control-btn:hover { color: #fff; text-shadow: 0 0 8px rgba(255,255,255,0.5); }
        .control-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .control-btn.play-btn { width: 36px; height: 36px; background: #fff; border-radius: 50%; color: #000; transition: transform 0.2s, box-shadow 0.2s; }
        .control-btn.play-btn:hover { transform: scale(1.1); background: var(--text-main); box-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .control-btn.play-btn svg { width: 16px; height: 16px; margin-left: 2px; }
        .control-btn.play-btn.playing svg { margin-left: 0; }
        .progress-area { width: 100%; max-width: 600px; display: flex; align-items: center; gap: 12px; font-size: 12px; color: #ddd; font-variant-numeric: tabular-nums; font-weight: 500; }
        .slider-container { flex: 1; position: relative; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; cursor: pointer; display: flex; align-items: center; }
        input[type="range"] { appearance: none; width: 100%; height: 4px; background: transparent; position: absolute; z-index: 2; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px; opacity: 0; transition: opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .slider-container:hover input[type="range"]::-webkit-slider-thumb { opacity: 1; }
        .slider-container:hover .progress-fill { background: var(--accent-hover); box-shadow: 0 0 8px var(--accent); }
        .progress-fill { position: absolute; left: 0; top: 0; bottom: 0; background: #fff; width: 0%; border-radius: 2px; pointer-events: none; z-index: 1; transition: background 0.2s; }
        .slider-container.active .progress-fill { background: var(--accent); }
        .shortcut-info { position: absolute; bottom: -20px; font-size: 10px; color: rgba(255,255,255,0.4); }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-header">Library</div>
    <div class="song-list" id="songList"></div>
</aside>

<main class="player" id="player">
    <header class="now-playing">
        <div class="now-title" id="nowTitle">Select a song</div>
        <div class="now-artist" id="nowArtist"></div>
    </header>
    
    <section class="lyrics-fixed-view">
        <div id="lyrics"></div>
    </section>
</main>

<footer class="controls">
    <div class="buttons-area">
        <button class="control-btn" id="prev" title="Previous (Ctrl + P)">
            <svg viewBox="0 0 16 16"><path d="M13 2.5L5 8l8 5.5V2.5zm-8.5 0v11h-2v-11h2z"/></svg>
        </button>
        
        <button class="control-btn play-btn" id="playPause" title="Play/Pause (Space)">
            <svg class="icon-play" viewBox="0 0 16 16"><path d="M4.5 3l9 5-9 5V3z"/></svg>
        </button>

        <button class="control-btn" id="next" title="Next (Ctrl + N)">
            <svg viewBox="0 0 16 16"><path d="M3 2.5L11 8l-8 5.5V2.5zm10.5 0v11h-2v-11h2z"/></svg>
        </button>
    </div>

    <div class="progress-area">
        <span id="currentTime">0:00</span>
        <div class="slider-container" id="sliderContainer">
            <div class="progress-fill" id="progressFill"></div>
            <input type="range" id="progress" min="0" max="100" value="0" step="0.1">
        </div>
        <span id="duration">0:00</span>
    </div>
    <div class="shortcut-info">
        Shortcuts: [Space] Play/Pause, [Ctrl + N] Next, [Ctrl + P] Previous
    </div>
</footer>

<audio id="audio"></audio>

<script>
const songs = [
    { id: 24, title: "All The Things She Said", artist: "t.A.T.u.", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Tatu%20-%20All%20The%20Things%20She%20Said.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/T.A.T.U.%20-%20All%20The%20Things%20She%20Said.lrc" },
    { id: 14, title: "Angel Baby", artist: "Troye Sivan", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Troye%20Sivan%20-%20Angel%20Baby.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Troye%20Sivan%20-%20Angel%20Baby.lrc" },
    { id: 15, title: "Angels Like You", artist: "Miley Cyrus", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Miley%20Cyrus%20-%20Angels%20Like%20You.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Miley%20Cyrus%20-%20Angels%20Like%20You.lrc" },
    { id: 3, title: "Diet Pepsi", artist: "Addison Rae", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Diet-pepsi.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Diet-pepsi.en.lrc" },
    { id: 17, title: "Drunk Text", artist: "Henry Moodie", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Henry%20Moodie%20-%20Drunk%20Text.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Drunk%20Text%20-%20Henry%20Moodie.lrc" },
    { id: 20, title: "Family Line", artist: "Conan Gray", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20Family%20Line.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20Family%20Line.lrc" },
    { id: 4, title: "Gnarly", artist: "KATSEYE", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/KATSEYE%20(캣츠아이)%20Gnarly%20Official%20MV.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/KATSEYE%20-%20Gnarly.en.lrc" },
    { id: 5, title: "Hall of Fame", artist: "The Script ft. will.i.am", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/The%20Script%20-%20Hall%20of%20Fame.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/The%20Script%20-%20Hall%20of%20Fame.am.lrc" },
    { id: 10, title: "Heather", artist: "Conan Gray", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20Heather.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20Heather.en.lrc" },
    { id: 11, title: "Memories", artist: "Conan Gray", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20Memories.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20Memories.en.lrc" },
    { id: 19, title: "Mockingbird", artist: "Eminem", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Eminem%20-%20Mockingbird.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Eminem%20-%20Mockingbird.lrc" },
    { id: 21, title: "Nauseous", artist: "Conan Gray", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20Nauseous.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20Nauseous.lrc" },
    { id: 1, title: "Ordinary", artist: "Alex Warren", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Alex%20Warren%20-%20Ordinary.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Alex%20Warren%20-%20Ordinary.en.lrc" },
    { id: 7, title: "Pacify Her", artist: "Melanie Martinez", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Melanie%20Martinez%20-%20Pacify%20Her.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Melanie%20Martinez%20-%20Pacify%20Her.en.lrc" },
    { id: 6, title: "Pity Party", artist: "Melanie Martinez", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Melanie%20Martinez%20-%20Pity%20Party.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Melanie%20Martinez%20-%20Pity%20Party.en.lrc" },
    { id: 18, title: "Sailor Song", artist: "Gigi Perez", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Gigi%20Perez%20-%20Sailor%20Song.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Gigi%20Perez%20-%20Sailor%20Song.lrc" },
    { id: 2, title: "Skyfall", artist: "Adele", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Adele%20-%20Skyfall%20(Official%20Lyric%20Video).mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/ADELE%20-%20Skyfall.en.lrc" },
    { id: 23, title: "Take Me To Church", artist: "Hozier", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Hozier%20-%20Take%20Me%20To%20Church.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Hozier%20-%20Take%20Me%20to%20Church.lrc" },
    { id: 22, title: "The Exit", artist: "Conan Gray", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20The%20Exit.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Conan%20Gray%20-%20The%20Exit.lrc" },
    { id: 9, title: "Too Sweet", artist: "Hozier", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Hozier%20-%20Too%20Sweet.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Hozier%20-%20Too%20Sweet.en.lrc" },
    { id: 12, title: "Viva La Vida", artist: "Coldplay", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Coldplay%20-%20Viva%20La%20Vida.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Coldplay%20-%20Viva%20La%20Vida.en.lrc" },
    { id: 16, title: "Young And Beautiful", artist: "Lana Del Rey", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Lana%20Del%20Rey%20-%20Young%20and%20Beautiful.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Lana%20Del%20Rey%20-%20Young%20and%20Beautiful.lrc" },
    { id: 13, title: "YOUTH", artist: "Troye Sivan", audioUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Troye%20Sivan%20-%20Youth.mp3", lyricsUrl: "https://raw.githubusercontent.com/Ly-z-sa/databasese/main/Troye%20Sivan%20-%20YOUTH.lrc" },
];

// --- Elements ---
const songListEl = document.getElementById('songList');
const audio = document.getElementById('audio');
const lyricsEl = document.getElementById('lyrics'); // The moving content container
const lyricsFixedView = document.querySelector('.lyrics-fixed-view'); // The fixed viewport
const playPauseBtn = document.getElementById('playPause');
const progress = document.getElementById('progress');
const progressFill = document.getElementById('progressFill');
const sliderContainer = document.getElementById('sliderContainer');
const nowTitle = document.getElementById('nowTitle');
const nowArtist = document.getElementById('nowArtist');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const currentTimeEl = document.getElementById('currentTime');
const durationEl = document.getElementById('duration');

// --- Icons ---
const playPath = '<path d="M4.5 3l9 5-9 5V3z"/>';
const pausePath = '<path d="M4 3h3v10H4V3zm5 0h3v10H9V3z"/>';

let currentLyrics = [];
let currentIndex = 0;
let isSeeking = false;  
let activeLineIndex = -1; 

// --- Init ---
songs.forEach((song,index)=>{
    const item=document.createElement('div');
    item.className='song-item';
    item.innerHTML=`<div class="song-title">${song.title}</div><div class="song-artist">${song.artist}</div>`;
    item.onclick=()=>loadSong(index);
    songListEl.appendChild(item);
});

// --- Functions ---
async function loadSong(index){
    if (!audio.paused) audio.pause();

    currentIndex = index;
    document.querySelectorAll('.song-item').forEach((el,i)=>el.classList.toggle('active',i===index));
    const song=songs[index];
    
    nowTitle.textContent=song.title;
    nowArtist.textContent=song.artist;
    audio.src=song.audioUrl;
    lyricsEl.innerHTML = '<div class="lyric-line" style="margin-top:40px; color:#666; font-size: 20px;">Loading lyrics...</div>';
    
    await loadLyrics(song.lyricsUrl);
    
    audio.play().catch(e => {
        console.log("Auto-play blocked", e);
        updatePlayButton(false);
    });
    updatePlayButton(true);
}

async function loadLyrics(url){
    try {
        const res=await fetch(url);
        const text=await res.text();
        currentLyrics=[];
        lyricsEl.innerHTML='';
        text.split('\n').forEach(line=>{
            const match=line.match(/\[(\d+):(\d+\.\d+)\](.*)/);
            if(!match) return;
            currentLyrics.push({
                time: parseInt(match[1])*60 + parseFloat(match[2]),
                content: match[3].trim()
            });
        });
        
        if(currentLyrics.length === 0) {
            lyricsEl.innerHTML = '<div class="lyric-line" style="margin-top:40px;">No Lyrics Found</div>';
            return;
        }

        currentLyrics.forEach((l, index)=>{
            const div=document.createElement('div');
            div.className='lyric-line';
            div.id = `lrc-line-${index}`; 
            div.textContent=l.content || "♪"; 
            div.onclick = () => {
                audio.currentTime = l.time;
                audio.play();
                updatePlayButton(true);
            };
            lyricsEl.appendChild(div);
        });
        
        activeLineIndex = -1; // Reset active index before scrolling
        scrollLyrics(0);
    } catch (e) {
        lyricsEl.innerHTML = '<div class="lyric-line" style="margin-top:40px;">Error loading lyrics</div>';
    }
}

function scrollLyrics(lineIndex) {
    const lines = lyricsEl.children;
    if (lineIndex < 0 || lineIndex >= lines.length) return;

    // 1. Update Active Class
    if (activeLineIndex >= 0 && lines[activeLineIndex]) {
        lines[activeLineIndex].classList.remove('active');
    }
    const activeLine = lines[lineIndex];
    activeLine.classList.add('active');
    activeLineIndex = lineIndex;

    // 2. Calculate the required vertical translation (in pixels)
    
    // Position of the center of the active line relative to the top of the #lyrics container.
    const lineCenterY = activeLine.offsetTop + (activeLine.offsetHeight / 2);

    // Center point of the fixed viewing area.
    const viewCenterY = lyricsFixedView.offsetHeight / 2;
    
    // The required shift (translateY) to move the lineCenterY to the viewCenterY.
    // Negating it moves the content UP.
    const translateY = -(lineCenterY - viewCenterY);

    // 3. Apply the GPU-accelerated CSS transform
    // translate(-50%, ...) keeps horizontal centering.
    // The second parameter is the calculated vertical offset in pixels.
    lyricsEl.style.transform = `translate(-50%, ${translateY}px)`;
}


function updatePlayButton(isPlaying) {
    if(isPlaying) {
        playPauseBtn.innerHTML = `<svg viewBox="0 0 16 16">${pausePath}</svg>`;
        playPauseBtn.classList.add('playing');
        sliderContainer.classList.add('active');
    } else {
        playPauseBtn.innerHTML = `<svg viewBox="0 0 16 16">${playPath}</svg>`;
        playPauseBtn.classList.remove('playing');
        sliderContainer.classList.remove('active');
    }
}

function formatTime(seconds) {
    if(isNaN(seconds)) return "0:00";
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
}


// --- Event Listeners ---
audio.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(audio.duration);
    progress.max = audio.duration;
});

// Primary function to handle lyric synchronization
audio.addEventListener('timeupdate', () => {
    // 1. Update Progress Bar
    if(!isSeeking) {
        const t = audio.currentTime;
        progress.value = t;
        const pct = (t / audio.duration) * 100;
        progressFill.style.width = `${pct}%`;
        currentTimeEl.textContent = formatTime(t);
    }

    // 2. Determine Active Lyric Line
    const t = audio.currentTime;
    let nextIndex = -1;
    for(let i=0; i<currentLyrics.length; i++){
        if(t >= currentLyrics[i].time) nextIndex = i;
        else break; 
    }

    // 3. Scroll only if the active line has changed
    if(nextIndex !== -1 && nextIndex !== activeLineIndex) {
        // We use requestAnimationFrame to ensure the scroll happens smoothly and after any reflow
        window.requestAnimationFrame(() => scrollLyrics(nextIndex));
    }
});

audio.addEventListener('ended', () => {
    updatePlayButton(false);
    nextTrack();
});

// Control Button Handlers
const playPauseHandler = () => {
    if (audio.paused) {
        if(!audio.src) loadSong(0);
        else audio.play();
        updatePlayButton(true);
    } else {
        audio.pause();
        updatePlayButton(false);
    }
};

const nextTrack = () => {
    loadSong((currentIndex + 1) % songs.length);
};

const previousTrack = () => {
    loadSong((currentIndex - 1 + songs.length) % songs.length);
};

playPauseBtn.onclick = playPauseHandler;
prevBtn.onclick = previousTrack;
nextBtn.onclick = nextTrack;

// Progress Bar Handlers
progress.addEventListener('input', () => {
    isSeeking = true;
    const val = progress.value;
    progressFill.style.width = `${(val / audio.duration) * 100}%`;
    currentTimeEl.textContent = formatTime(val);
});
progress.addEventListener('change', () => {
    isSeeking = false;
    audio.currentTime = progress.value;
    // Manually trigger timeupdate to update lyrics instantly after seeking
    audio.dispatchEvent(new Event('timeupdate')); 
    if(audio.paused) { audio.play(); updatePlayButton(true); }
});


// Keyboard Shortcuts Listener
document.addEventListener('keydown', (event) => {
    // Check if the focus is on an input or text area (to avoid unwanted triggers)
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
        return;
    }

    // Spacebar: Play/Pause
    if (event.code === 'Space') {
        event.preventDefault(); 
        playPauseHandler();
    }
    // Ctrl + N: Next Track
    else if (event.ctrlKey && event.key === 'ArrowRight') {
        event.preventDefault(); 
        nextTrack(); 
    }
    // Ctrl + P: Previous Track
    else if (event.ctrlKey && event.key === 'ArrowLeft') {
        event.preventDefault();
        previousTrack();
    }
});
</script>
</body>
</html>
